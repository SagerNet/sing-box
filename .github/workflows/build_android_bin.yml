name: Build Android Binary

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version name"
        required: true
        type: string

jobs:
  calculate_version:
    name: Calculate version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.outputs.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set version
        id: outputs
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            go run -v ./cmd/internal/read_tag --ci --nightly
            echo "version=$version" >> "$GITHUB_OUTPUT"
          fi

  build_android_bin:
    name: Build Android Binary
    runs-on: ubuntu-latest
    needs: calculate_version
    strategy:
      matrix:
        include:
          - { arch: arm64, ndk_target: "aarch64-linux-android23", naive: true }
          - { arch: arm, ndk_target: "armv7a-linux-androideabi23", naive: true }
          - { arch: amd64, ndk_target: "x86_64-linux-android23", naive: true }
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ~1.25.7

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r28

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build pkg-config curl xz-utils

      - name: Cache Cronet Build
        if: matrix.naive
        id: cache-cronet
        uses: actions/cache@v4
        with:
          path: |
            ~/cronet-go/naiveproxy/src/third_party/llvm-build/
            ~/cronet-go/naiveproxy/src/out/
            ~/cronet-go/naiveproxy/src/build/linux/sysroot_scripts/
          key: cronet-${{ matrix.arch }}-${{ hashFiles('.github/CRONET_GO_VERSION') }}
          restore-keys: |
            cronet-${{ matrix.arch }}-

      - name: Clone and Build Cronet
        if: matrix.naive
        run: |
          set -xeuo pipefail
          CRONET_GO_VERSION=$(cat .github/CRONET_GO_VERSION || echo "main")
          git clone --depth=1 https://github.com/sagernet/cronet-go.git ~/cronet-go
          cd ~/cronet-go
          git submodule update --init --recursive --depth=1
          
          go run ./cmd/build-naive download-toolchain --target=android/${{ matrix.arch }}
          
          go run ./cmd/build-naive build --target=android/${{ matrix.arch }}
          
          LIB_PATH=$(find ~/cronet-go -name "libcronet_static.a" | head -n 1)
          echo "CRONET_LIB_DIR=$(dirname $LIB_PATH)" >> $GITHUB_ENV
          echo "找到了静态库: $LIB_PATH"

      - name: Set Build Tags
        run: |
          TAGS='with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale,with_ccm,with_ocm,badlinkname,tfogo_checklinkname0'
          if [[ "${{ matrix.naive }}" == "true" ]]; then
            TAGS="${TAGS},with_naive_outbound"
          fi
          echo "BUILD_TAGS=${TAGS}" >> $GITHUB_ENV

      - name: Build Sing-box Binary
        run: |
          set -xeuo pipefail
          go install -v ./cmd/internal/build
          
          # NDK 工具链配置
          NDK_PATH="${{ steps.setup-ndk.outputs.ndk-path }}"
          TOOLCHAIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          export CC="$TOOLCHAIN/${{ matrix.ndk_target }}-clang"
          export CXX="$TOOLCHAIN/${{ matrix.ndk_target }}-clang++"
          
          export CGO_LDFLAGS="-L${{ env.CRONET_LIB_DIR }} -lcronet_static -lc++"
          
          mkdir -p dist
          CGO_ENABLED=1 GOOS=android GOARCH=${{ matrix.arch }} \
          build go build -v -trimpath -o dist/sing-box -tags "${BUILD_TAGS}" \
          -ldflags "-s -w -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ needs.calculate_version.outputs.version }} -X internal/godebug.defaultGODEBUG=multipathtcp=0 -checklinkname=0" \
          ./cmd/sing-box

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-android-${{ matrix.arch }}
          path: dist/
